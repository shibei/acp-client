# ACPClient - å¤©æ–‡å°è‡ªåŠ¨è§‚æµ‹æ§åˆ¶ç³»ç»Ÿ

## é¡¹ç›®ç®€ä»‹

ACPClient æ˜¯ä¸€ä¸ªåŸºäº Python çš„å¤©æ–‡å°è‡ªåŠ¨è§‚æµ‹æ§åˆ¶ç³»ç»Ÿï¼Œä¸“é—¨è®¾è®¡ç”¨äºä¸ ACP (Astronomy Control Program) å¤©æ–‡å°æ§åˆ¶è½¯ä»¶è¿›è¡Œäº¤äº’ã€‚è¯¥ç³»ç»Ÿæ”¯æŒå¤šç›®æ ‡è‡ªåŠ¨è§‚æµ‹ã€ä¸­å¤©åè½¬ç®¡ç†ã€æ»¤é•œè½®æ§åˆ¶ç­‰é«˜çº§åŠŸèƒ½ï¼Œä¸ºå¤©æ–‡æ‘„å½±å’Œè§‚æµ‹æä¾›å®Œæ•´çš„è‡ªåŠ¨åŒ–è§£å†³æ–¹æ¡ˆã€‚

## ä¸»è¦ç‰¹æ€§

### ğŸŒŸ æ ¸å¿ƒåŠŸèƒ½
- **å¤šç›®æ ‡è‡ªåŠ¨è§‚æµ‹**: æ”¯æŒæŒ‰ä¼˜å…ˆçº§å’Œæ—¶é—´è°ƒåº¦å¤šä¸ªè§‚æµ‹ç›®æ ‡
- **å®æ—¶çŠ¶æ€ç›‘æ§**: å®æ—¶ç›‘æ§å¤©æ–‡å°è®¾å¤‡çŠ¶æ€ï¼ˆæœ›è¿œé•œã€ç›¸æœºã€å¯¼æ˜Ÿå™¨ç­‰ï¼‰
- **ä¸­å¤©åè½¬ç®¡ç†**: æ™ºèƒ½å¤„ç†ä¸­å¤©åè½¬ï¼Œç¡®ä¿è§‚æµ‹è¿ç»­æ€§
- **æ»¤é•œè½®æ§åˆ¶**: æ”¯æŒå¤šæ»¤é•œåºåˆ—è§‚æµ‹ï¼ˆLRGBã€H-alphaã€OIIIã€SIIç­‰ï¼‰
- **è‡ªåŠ¨å¯¹ç„¦**: æ”¯æŒå‘¨æœŸæ€§è‡ªåŠ¨å¯¹ç„¦å’ŒæŠ–åŠ¨åŠŸèƒ½

### ğŸ”§ æŠ€æœ¯ç‰¹æ€§
- **æ¨¡å—åŒ–æ¶æ„**: åŸºäºé‡æ„çš„æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤
- **HARæ–‡ä»¶åˆ†æ**: åŸºäºå®é™…ç½‘ç»œæŠ“åŒ…åˆ†æï¼Œç¡®ä¿åè®®å…¼å®¹æ€§
- **å®¹é”™å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **æ—¥å¿—ç³»ç»Ÿ**: è¯¦ç»†çš„æ—¥å¿—è®°å½•å’ŒçŠ¶æ€ç›‘æ§
- **DRYRUNæ¨¡å¼**: æ”¯æŒæ¨¡æ‹Ÿè¿è¡Œï¼Œä¾¿äºæµ‹è¯•å’ŒéªŒè¯

## ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶
```
app/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ core/                    # æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ acp_client.py       # ACPå®¢æˆ·ç«¯æ ¸å¿ƒç±»
â”‚   â”‚   â”œâ”€â”€ acp_connection_manager.py  # è¿æ¥ç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ acp_imaging_manager.py     # æˆåƒç®¡ç†å™¨
â”‚   â”œâ”€â”€ config/                  # é…ç½®ç®¡ç†
â”‚   â”‚   â””â”€â”€ config_manager.py   # é…ç½®æ–‡ä»¶ç®¡ç†å™¨
â”‚   â”œâ”€â”€ execution/               # æ‰§è¡Œå¼•æ“
â”‚   â”‚   â””â”€â”€ target_observation_executor.py  # ç›®æ ‡è§‚æµ‹æ‰§è¡Œå™¨
â”‚   â”œâ”€â”€ scheduling/              # è°ƒåº¦ç³»ç»Ÿ
â”‚   â”‚   â””â”€â”€ target_scheduler.py # ç›®æ ‡è°ƒåº¦å™¨
â”‚   â””â”€â”€ utils/                   # å·¥å…·æ¨¡å—
â”‚       â”œâ”€â”€ log_manager.py      # æ—¥å¿—ç®¡ç†å™¨
â”‚       â”œâ”€â”€ time_utils.py       # æ—¶é—´å·¥å…·
â”‚       â””â”€â”€ observation_utils.py # è§‚æµ‹å·¥å…·
â”œâ”€â”€ new_main.py                 # æ–°æ¶æ„ä¸»ç¨‹åº
â””â”€â”€ multi_target_config.yaml    # é…ç½®æ–‡ä»¶ç¤ºä¾‹
```

### æ•°æ®æµ
1. **é…ç½®åŠ è½½**: ä» YAML é…ç½®æ–‡ä»¶è¯»å–è§‚æµ‹å‚æ•°
2. **ç›®æ ‡éªŒè¯**: éªŒè¯ç›®æ ‡å¯è§‚æµ‹æ€§å’Œæ—¶é—´æœ‰æ•ˆæ€§
3. **è°ƒåº¦è®¡ç®—**: åŸºäºä¼˜å…ˆçº§å’Œæ—¶é—´çª—å£è¿›è¡Œè°ƒåº¦
4. **è§‚æµ‹æ‰§è¡Œ**: æŒ‰é¡ºåºæ‰§è¡Œç›®æ ‡è§‚æµ‹è®¡åˆ’
5. **çŠ¶æ€ç›‘æ§**: å®æ—¶ç›‘æ§å’Œæ—¥å¿—è®°å½•

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Python 3.7+
- ä¾èµ–åº“ï¼š
  ```bash
  pip install requests beautifulsoup4 pyyaml numpy astropy
  ```

### åŸºæœ¬ç”¨æ³•

1. **é…ç½®æ–‡ä»¶å‡†å¤‡**
   ```yaml
   # multi_target_config.yaml
   acp_server:
     url: 'http://your-acp-server:port'
     username: 'your_username'
     password: 'your_password'
   
   targets:
     - name: 'NGC 1499'
       ra: '04:01:07.51'
       dec: '+36:31:11.9'
       start_time: '2025-11-28 14:17:00'
       priority: 1
       filters:
         - filter_id: 4
           name: 'H-alpha'
           exposure: 600
           count: 20
           binning: 1
   ```

2. **è¿è¡Œè§‚æµ‹**
   ```bash
   cd app
   python new_main.py --config multi_target_config.yaml
   ```

3. **éªŒè¯æ¨¡å¼**ï¼ˆæ¨èé¦–æ¬¡ä½¿ç”¨ï¼‰
   ```bash
   python new_main.py --config multi_target_config.yaml --validate
   ```

4. **DRYRUNæ¨¡å¼**ï¼ˆæ¨¡æ‹Ÿè¿è¡Œï¼‰
   ```bash
   python new_main.py --config multi_target_config.yaml --dry-run
   ```

### å‘½ä»¤è¡Œå‚æ•°
```bash
python new_main.py [é€‰é¡¹]

é€‰é¡¹:
  -c, --config PATH    é…ç½®æ–‡ä»¶è·¯å¾„ (é»˜è®¤: multi_target_config.yaml)
  -d, --dry-run       DRYRUNæ¨¡å¼ (ä¸å®é™…æ‰§è¡Œè§‚æµ‹)
  -v, --validate      ä»…éªŒè¯é…ç½®å’Œç›®æ ‡ï¼Œä¸æ‰§è¡Œè§‚æµ‹
  -s, --summary       æ˜¾ç¤ºè°ƒåº¦æ‘˜è¦
  -h, --help          æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

## é…ç½®è¯¦è§£

### ACPæœåŠ¡å™¨é…ç½®
```yaml
acp_server:
  url: 'http://your-server:port'    # ACPæœåŠ¡å™¨åœ°å€
  username: 'username'               # ç™»å½•ç”¨æˆ·å
  password: 'password'               # ç™»å½•å¯†ç 
```

### è§‚æµ‹ç›®æ ‡é…ç½®
```yaml
targets:
  - name: 'ç›®æ ‡åç§°'                  # ç›®æ ‡åç§°
    ra: 'HH:MM:SS.ss'               # èµ¤ç» (J2000)
    dec: '+DD:MM:SS.s'               # èµ¤çº¬ (J2000)
    start_time: 'YYYY-MM-DD HH:MM:SS' # å¼€å§‹æ—¶é—´
    priority: 1                       # ä¼˜å…ˆçº§ (æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜)
    filters:                          # æ»¤é•œé…ç½®åˆ—è¡¨
      - filter_id: 0                  # æ»¤é•œID
        name: 'L'                     # æ»¤é•œåç§°
        exposure: 300                 # æ›å…‰æ—¶é—´ (ç§’)
        count: 10                     # æ‹æ‘„æ•°é‡
        binning: 1                    # åƒç´ åˆå¹¶
```

### ä¸­å¤©åè½¬é…ç½®
```yaml
meridian_flip:
  stop_minutes_before: 10    # ä¸­å¤©å‰åœæ­¢è§‚æµ‹æ—¶é—´ (åˆ†é’Ÿ)
  resume_minutes_after: 10   # ä¸­å¤©åæ¢å¤è§‚æµ‹æ—¶é—´ (åˆ†é’Ÿ)
  safety_margin: 5           # å®‰å…¨è¾¹è· (åˆ†é’Ÿ)
```

### è§‚æµ‹ç«™ä½ç½®
```yaml
observatory:
  latitude: 39.9    # è§‚æµ‹ç«™çº¬åº¦ (åº¦)
  longitude: 116.4  # è§‚æµ‹ç«™ç»åº¦ (åº¦)
```

### å…¨å±€è®¾ç½®
```yaml
global_settings:
  dither: 5              # æŠ–åŠ¨èŒƒå›´ (åƒç´ )
  auto_focus: true       # è‡ªåŠ¨å¯¹ç„¦
  af_interval: 120       # è‡ªåŠ¨å¯¹ç„¦é—´éš” (ç§’)
  dryrun: false          # DRYRUNæ¨¡å¼
```

## APIæ¥å£

### ACPClientç±»
```python
from app.lib.core.acp_client import ACPClient, ImagingPlan

# åˆ›å»ºå®¢æˆ·ç«¯
client = ACPClient(
    base_url='http://server:port',
    user='username',
    password='password'
)

# è·å–ç³»ç»ŸçŠ¶æ€
status = client.get_system_status()
print(f"å¤©æ–‡å°çŠ¶æ€: {status.observatory_status}")

# åˆ›å»ºæˆåƒè®¡åˆ’
plan = ImagingPlan(
    target='M 31',
    ra='00:42:44.33',
    dec='+41:16:07.5',
    filters=[
        {'filter': 0, 'count': 10, 'exposure': 300, 'binning': 1}
    ]
)

# å¯åŠ¨è§‚æµ‹
success = client.start_imaging_plan(plan)
```

### å¤šç›®æ ‡åè°ƒå™¨
```python
from app.lib.new_multi_target_orchestrator import NewMultiTargetOrchestrator

# åˆ›å»ºåè°ƒå™¨
orchestrator = NewMultiTargetOrchestrator(
    config_file='config.yaml',
    dry_run=False
)

# éªŒè¯ç›®æ ‡
results = orchestrator.validate_targets()

# è¿è¡Œè§‚æµ‹åºåˆ—
results = orchestrator.run_observation_sequence()
```

## æµ‹è¯•ä¸éªŒè¯

### å•å…ƒæµ‹è¯•
```bash
cd tests
python test_acp_client.py      # æµ‹è¯•ACPå®¢æˆ·ç«¯
python test_har_analysis.py    # æµ‹è¯•HARæ–‡ä»¶åˆ†æ
```

### åŠŸèƒ½æ¼”ç¤º
```bash
python demo_har_analysis.py    # HARæ–‡ä»¶åˆ†ææ¼”ç¤º
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ACPæœåŠ¡å™¨åœ°å€å’Œç«¯å£
   - éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
   - ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸

2. **ç›®æ ‡ä¸å¯è§‚æµ‹**
   - æ£€æŸ¥ç›®æ ‡åæ ‡æ ¼å¼
   - éªŒè¯è§‚æµ‹ç«™ä½ç½®è®¾ç½®
   - ç¡®è®¤è§‚æµ‹æ—¶é—´çª—å£

3. **æˆåƒè®¡åˆ’å¤±è´¥**
   - æ£€æŸ¥æ»¤é•œé…ç½®
   - éªŒè¯æ›å…‰å‚æ•°
   - æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

### æ—¥å¿—åˆ†æ
æ—¥å¿—æ–‡ä»¶ä½äº `app/logs/` ç›®å½•ï¼ŒæŒ‰æ—¥æœŸåˆ†ç±»ï¼š
```
MultiTargetOrchestrator_YYYYMMDD.log
```

## å¼€å‘æŒ‡å—

### æ¶æ„è®¾è®¡
- **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ªåŠŸèƒ½æ¨¡å—èŒè´£å•ä¸€ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
- **ä¾èµ–æ³¨å…¥**: é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–ï¼Œæé«˜ä»£ç å¯æµ‹è¯•æ€§
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé”™è¯¯æ¢å¤æœºåˆ¶
- **é…ç½®é©±åŠ¨**: YAMLé…ç½®æ–‡ä»¶é©±åŠ¨ï¼Œçµæ´»é€‚åº”ä¸åŒåœºæ™¯

### æ‰©å±•å¼€å‘
1. **æ·»åŠ æ–°æ»¤é•œ**: åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰æ–°çš„filter_idå’Œå‚æ•°
2. **è‡ªå®šä¹‰è°ƒåº¦**: ç»§æ‰¿TargetSchedulerç±»å®ç°è‡ªå®šä¹‰è°ƒåº¦ç®—æ³•
3. **æ–°è®¾å¤‡æ”¯æŒ**: æ‰©å±•ACPClientç±»æ”¯æŒæ–°çš„ç¡¬ä»¶è®¾å¤‡

## ç‰ˆæœ¬å†å²

è¯¦è§ [CHANGELOG.md](CHANGELOG.md) æ–‡ä»¶

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›é¡¹ç›®ã€‚

### å¼€å‘ç¯å¢ƒè®¾ç½®
```bash
git clone <repository-url>
cd ACPClient
pip install -r requirements.txt  # å¦‚æœæœ‰çš„è¯
```

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦è§ LICENSE æ–‡ä»¶

## è”ç³»æ–¹å¼

- é¡¹ç›®ç»´æŠ¤è€…: [Your Name]
- é‚®ç®±: [your.email@example.com]
- é¡¹ç›®ä¸»é¡µ: [Project URL]

## è‡´è°¢

- æ„Ÿè°¢ ACP å¤©æ–‡å°æ§åˆ¶è½¯ä»¶çš„å¼€å‘å›¢é˜Ÿ
- æ„Ÿè°¢å¼€æºç¤¾åŒºæä¾›çš„ä¼˜ç§€å·¥å…·å’Œåº“
- æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…å’Œæµ‹è¯•è€…çš„æ”¯æŒ

---

**æ³¨æ„**: æœ¬é¡¹ç›®åŸºäº HAR æ–‡ä»¶åˆ†æå’Œç½‘ç»œåè®®é€†å‘å·¥ç¨‹å¼€å‘ï¼Œä»…ç”¨äºæ•™è‚²å’Œç ”ç©¶ç›®çš„ã€‚ä½¿ç”¨æœ¬è½¯ä»¶è¿›è¡Œå¤©æ–‡è§‚æµ‹æ—¶ï¼Œè¯·ç¡®ä¿éµå®ˆç›¸å…³å®‰å…¨è§„å®šå’Œæ“ä½œè§„èŒƒã€‚